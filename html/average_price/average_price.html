<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Futures Average Price Calculator</title>
    <style>
        /* 全局样式 */
        body {
            font-family: 'Roboto', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f0f2f5; /* 更柔和的背景色 */
            color: #34495e; /* 深蓝色文字 */
            line-height: 1.6;
        }
        h1, h2 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 25px;
            font-weight: 600; /* 标题稍微粗一点 */
        }
        .container {
            max-width: 960px;
            margin: 30px auto;
            background-color: #ffffff;
            padding: 35px;
            border-radius: 12px; /* 更大的圆角 */
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.1); /* 更深更柔和的阴影 */
        }

        /* 区块样式 */
        .input-section, .table-section, .action-section, .average-price-display {
            margin-bottom: 30px;
            padding: 25px;
            border: 1px solid #e9ecef; /* 极浅的边框 */
            border-radius: 10px;
            background-color: #ffffff; /* 内部区块也用白色背景 */
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.06); /* 内部区块的轻微阴影 */
        }
        .average-price-display {
            background-color: #e6f4ea; /* 浅绿色背景 */
            border-color: #a8e6b5; /* 绿色边框 */
            text-align: center;
            font-size: 1.6em; /* 稍微大一点 */
            font-weight: bold;
            color: #2e7d32; /* 深绿色文字 */
            padding: 22px; /* 稍微多一点的内边距 */
            margin-top: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08); /* 均价块的阴影 */
        }

        /* 输入框布局 */
        .input-fields-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 25px;
            margin-bottom: 20px;
            justify-content: space-between;
        }
        .input-group-item {
            flex: 1 1 calc(50% - 12.5px);
            display: flex;
            flex-direction: column;
            min-width: 280px;
        }
        .input-group-item label {
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
            font-size: 0.95em;
        }
        .input-group-item input[type="number"] {
            padding: 12px 15px;
            border: 1px solid #ced4da; /* 默认边框色 */
            border-radius: 6px;
            font-size: 1em;
            box-sizing: border-box;
            width: 100%;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        .input-group-item input[type="number"]:focus {
            border-color: #4CAF50;
            box-shadow: 0 0 0 4px rgba(76, 175, 80, 0.25); /* 更明显的聚焦阴影 */
            outline: none;
        }

        /* 按钮样式 */
        button {
            padding: 12px 25px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            margin-right: 15px;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.15); /* 按钮默认阴影 */
        }
        button:last-child {
            margin-right: 0;
        }
        button:hover {
            transform: translateY(-3px); /* 稍微大一点的位移 */
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.25); /* 更明显的悬停阴影 */
        }

        button.primary {
            background-color: #4CAF50; /* 绿色 */
            color: white;
        }
        button.primary:hover {
            background-color: #43a047;
        }
        button.danger {
            background-color: #f44336; /* 红色 */
            color: white;
        }
        button.danger:hover {
            background-color: #e53935;
        }
        button.success {
            background-color: #2196F3; /* 蓝色 */
            color: white;
        }
        button.success:hover {
            background-color: #1976D2;
        }
        button.info {
            background-color: #ff9800; /* 橙色 */
            color: white;
        }
        button.info:hover {
            background-color: #fb8c00;
        }

        /* 表格容器，用于横向滚动 */
        .table-responsive {
            overflow-x: auto; /* 启用横向滚动 */
            -webkit-overflow-scrolling: touch; /* iOS 上的平滑滚动 */
            border-radius: 8px; /* 继承表格的圆角 */
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1); /* 继承表格的阴影 */
            margin-top: 25px; /* 保持与表格的间距 */
        }

        /* 表格样式 */
        table {
            width: 100%; /* 确保表格宽度可以撑开 */
            min-width: 600px; /* 确保表格在小屏幕下有最小宽度，以触发滚动 */
            border-collapse: collapse;
            background-color: #fff;
            /* box-shadow 和 border-radius 移动到 .table-responsive */
        }
        th, td {
            padding: 14px 18px;
            text-align: left;
            border-bottom: 1px solid #e9ecef; /* 更细的边框 */
        }
        th {
            background-color: #f8f9fa; /* 浅灰色表头背景 */
            color: #2c3e50;
            font-weight: bold;
            text-transform: uppercase;
            font-size: 0.9em;
        }
        tr:nth-child(even) {
            background-color: #fcfdff; /* 斑马纹 */
        }
        tr:hover {
            background-color: #f5f7fa; /* 悬停高亮 */
        }
        td button {
            padding: 8px 12px;
            font-size: 0.8em;
            margin-right: 0;
            box-shadow: none; /* 表格内的按钮不需要阴影 */
            transform: none; /* 表格内的按钮不需要位移效果 */
        }
        td button:hover {
            background-color: #e0e0e0; /* 表格内删除按钮悬停效果 */
        }

        .action-buttons-container {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            margin-top: 20px;
        }

        /* 响应式调整 */
        @media (max-width: 768px) {
            .container {
                padding: 20px;
                margin: 20px auto;
            }
            .input-fields-grid {
                flex-direction: column;
                gap: 15px;
            }
            .input-group-item {
                flex: 1 1 100%;
                min-width: unset;
            }
            button {
                width: 100%;
                margin-bottom: 10px;
                margin-right: 0;
            }
            .action-buttons-container {
                flex-direction: column;
            }
            th, td {
                padding: 10px 12px; /* 稍微减少内边距 */
                font-size: 0.85em; /* 稍微减小字体 */
            }
            th {
                white-space: nowrap; /* 防止表头文字换行 */
            }
            /* 移除表格在小屏幕下的阴影和圆角，由 .table-responsive 统一管理 */
            table {
                box-shadow: none;
                border-radius: 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>期货均价计算器</h1>

        <div class="input-section">
            <h2>输入交易参数</h2>
            <div class="input-fields-grid">
                <div class="input-group-item">
                    <label for="marginRatio">保证金比例 (%):</label>
                    <input type="number" id="marginRatio" value="10" min="0.01" step="0.01" placeholder="例如: 10 (表示10%)">
                </div>
                <div class="input-group-item">
                    <label for="unitsPerLot">每手单位:</label>
                    <input type="number" id="unitsPerLot" value="10" min="1" step="1" placeholder="例如: 10">
                </div>
                <div class="input-group-item">
                    <label for="openPrice">开仓价格:</label>
                    <input type="number" id="openPrice" value="5000" min="0.01" step="0.01" placeholder="例如: 5000">
                </div>
                <div class="input-group-item">
                    <label for="openAmount">开仓金额 (元):</label>
                    <input type="number" id="openAmount" value="100000" min="0.01" step="0.01" placeholder="例如: 100000">
                </div>
            </div>
            <button id="addTradeBtn" class="primary">添加交易</button>
        </div>

        <div class="table-section">
            <h2>交易列表</h2>
            <!-- 新增的 table-responsive 容器 -->
            <div class="table-responsive">
                <table id="tradeTable">
                    <thead>
                        <tr>
                            <th>保证金比例 (%)</th>
                            <th>每手单位</th>
                            <th>开仓价格</th>
                            <th>开仓金额 (元)</th>
                            <th>开仓手数</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="tradeList">
                        <!-- 交易行将在这里动态添加 -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 均价显示块 -->
        <div id="averagePriceDisplay" class="average-price-display">
            点击“计算均价”按钮显示结果
        </div>

        <div class="action-section action-buttons-container">
            <button id="calculateAvgBtn" class="success">计算均价</button>
            <!-- 导入按钮和隐藏的文件输入框 -->
            <input type="file" id="csvFileInput" accept=".csv" style="display: none;">
            <button id="importCsvBtn" class="info">导入数据 (CSV)</button>
            <button id="exportCsvBtn" class="info">导出数据 (CSV)</button>
        </div>
    </div>

    <script>
        // 获取DOM元素
        const marginRatioInput = document.getElementById('marginRatio');
        const unitsPerLotInput = document.getElementById('unitsPerLot');
        const openPriceInput = document.getElementById('openPrice');
        const openAmountInput = document.getElementById('openAmount');
        const addTradeBtn = document.getElementById('addTradeBtn');
        const tradeListBody = document.getElementById('tradeList');
        const calculateAvgBtn = document.getElementById('calculateAvgBtn');
        const exportCsvBtn = document.getElementById('exportCsvBtn');
        const averagePriceDisplay = document.getElementById('averagePriceDisplay');
        const importCsvBtn = document.getElementById('importCsvBtn');
        const csvFileInput = document.getElementById('csvFileInput');

        // 存储交易数据的数组
        let trades = [];

        // 函数：添加交易
        function addTrade() {
            const marginRatio = parseFloat(marginRatioInput.value);
            const unitsPerLot = parseFloat(unitsPerLotInput.value);
            const openPrice = parseFloat(openPriceInput.value);
            const openAmount = parseFloat(openAmountInput.value);

            // 验证输入
            if (isNaN(marginRatio) || isNaN(unitsPerLot) || isNaN(openPrice) || isNaN(openAmount) ||
                marginRatio <= 0 || unitsPerLot <= 0 || openPrice <= 0 || openAmount <= 0) {
                alert('请输入有效的正数作为交易参数！');
                return;
            }

            // 计算开仓手数
            // 开仓手数 = 开仓金额 / (开仓价格 * 每手单位)
            const lots = openAmount / (openPrice * unitsPerLot);

            // 创建交易对象
            const newTrade = {
                marginRatio: marginRatio,
                unitsPerLot: unitsPerLot,
                openPrice: openPrice,
                openAmount: openAmount,
                lots: lots
            };

            // 将新交易添加到数组
            trades.push(newTrade);

            // 渲染表格
            renderTable();

            // 清空均价显示
            averagePriceDisplay.textContent = '点击“计算均价”按钮显示结果';
        }

        // 函数：渲染表格
        function renderTable() {
            tradeListBody.innerHTML = ''; // 清空现有表格内容

            trades.forEach((trade, index) => {
                const row = tradeListBody.insertRow();

                row.insertCell().textContent = trade.marginRatio.toFixed(2);
                row.insertCell().textContent = trade.unitsPerLot.toFixed(2);
                row.insertCell().textContent = trade.openPrice.toFixed(2);
                row.insertCell().textContent = trade.openAmount.toFixed(2);
                row.insertCell().textContent = trade.lots.toFixed(4); // 手数可能需要更多小数位

                const actionCell = row.insertCell();
                const deleteButton = document.createElement('button');
                deleteButton.textContent = '删除';
                deleteButton.className = 'danger';
                deleteButton.onclick = () => deleteTrade(index); // 绑定删除事件
                actionCell.appendChild(deleteButton);
            });
        }

        // 函数：删除交易
        function deleteTrade(index) {
            if (confirm('确定要删除这笔交易吗？')) {
                trades.splice(index, 1); // 从数组中删除指定索引的交易
                renderTable(); // 重新渲染表格
                // 清空均价显示
                averagePriceDisplay.textContent = '点击“计算均价”按钮显示结果';
            }
        }

        // 函数：计算均价
        function calculateAveragePrice() {
            if (trades.length === 0) {
                averagePriceDisplay.textContent = '请先添加交易数据！';
                return;
            }

            let totalWeightedPrice = 0; // 总加权价格 (价格 * 手数)
            let totalLots = 0;           // 总手数

            trades.forEach(trade => {
                totalWeightedPrice += trade.openPrice * trade.lots;
                totalLots += trade.lots;
            });

            if (totalLots === 0) {
                averagePriceDisplay.textContent = '无法计算均价，总手数为零。请检查开仓金额或每手单位是否正确。';
                return;
            }

            const averagePrice = totalWeightedPrice / totalLots;
            averagePriceDisplay.textContent = `计算出的期货均价为: ${averagePrice.toFixed(4)}`; // 显示在块中
        }

        // 函数：导出CSV
        function exportCsv() {
            if (trades.length === 0) {
                alert('没有数据可以导出！');
                return;
            }

            let csvContent = "data:text/csv;charset=utf-8,\uFEFF"; // 添加BOM头解决中文乱码

            // CSV 表头
            csvContent += "保证金比例 (%),每手单位,开仓价格,开仓金额 (元),开仓手数\n";

            // CSV 数据行
            trades.forEach(trade => {
                csvContent += `${trade.marginRatio.toFixed(2)},${trade.unitsPerLot.toFixed(2)},${trade.openPrice.toFixed(2)},${trade.openAmount.toFixed(2)},${trade.lots.toFixed(4)}\n`;
            });

            // 添加均价行
            let totalWeightedPrice = 0;
            let totalLots = 0;
            trades.forEach(trade => {
                totalWeightedPrice += trade.openPrice * trade.lots;
                totalLots += trade.lots;
            });

            let averagePrice = 0;
            if (totalLots > 0) {
                averagePrice = totalWeightedPrice / totalLots;
            }
            // 注意：导出时均价行只在最后一列显示，前面留空，方便导入时识别和跳过
            csvContent += `\n最终计算均价,,,,${averagePrice.toFixed(4)}\n`;

            // 创建下载链接
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "futures_average_price_data.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // 函数：导入CSV
        function importCsv(event) {
            const file = event.target.files[0];
            if (!file) {
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const csvText = e.target.result;
                parseCsvAndLoadTable(csvText);
            };
            reader.onerror = function() {
                alert('读取文件失败！');
            };
            reader.readAsText(file, 'UTF-8'); // 使用UTF-8编码读取，处理BOM
        }

        // 函数：解析CSV文本并加载到表格
        function parseCsvAndLoadTable(csvText) {
            const lines = csvText.split('\n').filter(line => line.trim() !== ''); // 过滤空行
            if (lines.length < 2) { // 至少需要标题行和一行数据
                alert('CSV文件内容不正确或为空！');
                return;
            }

            // 清空现有数据
            trades = [];
            averagePriceDisplay.textContent = '点击“计算均价”按钮显示结果';

            // 跳过表头 (第一行)
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                const columns = line.split(',');

                // 检查是否是均价行 (均价行通常只有最后一列有数据，或者列数不匹配)
                // 假设均价行是最后一行，且前几列为空
                if (columns.length < 5 || columns[0].trim() === '最终计算均价') {
                    continue; // 跳过均价行
                }

                const marginRatio = parseFloat(columns[0]);
                const unitsPerLot = parseFloat(columns[1]);
                const openPrice = parseFloat(columns[2]);
                const openAmount = parseFloat(columns[3]);
                
                if (isNaN(marginRatio) || isNaN(unitsPerLot) || isNaN(openPrice) || isNaN(openAmount) ||
                    marginRatio <= 0 || unitsPerLot <= 0 || openPrice <= 0 || openAmount <= 0) {
                    console.warn('跳过无效行:', line);
                    continue; // 跳过无效数据行
                }

                const lots = openAmount / (openPrice * unitsPerLot); // 重新计算手数

                trades.push({
                    marginRatio: marginRatio,
                    unitsPerLot: unitsPerLot,
                    openPrice: openPrice,
                    openAmount: openAmount,
                    lots: lots
                });
            }

            if (trades.length === 0) {
                alert('CSV文件中没有有效的交易数据可导入！');
            } else {
                renderTable();
                alert(`成功导入 ${trades.length} 条交易数据！`);
            }
        }


        // 绑定事件监听器
        addTradeBtn.addEventListener('click', addTrade);
        calculateAvgBtn.addEventListener('click', calculateAveragePrice);
        exportCsvBtn.addEventListener('click', exportCsv);

        // 导入按钮点击时，触发隐藏的文件输入框
        importCsvBtn.addEventListener('click', () => {
            csvFileInput.click();
        });
        // 文件输入框选择文件后，处理文件
        csvFileInput.addEventListener('change', importCsv);

        // 初始渲染
        renderTable();
    </script>
</body>
</html>