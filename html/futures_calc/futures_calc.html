<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>期货综合计算器</title>
    <style>
        /* 全局样式 */
        body {
            font-family: 'Roboto', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f0f2f5; /* 更柔和的背景色 */
            color: #34495e; /* 深蓝色文字 */
            line-height: 1.6;
        }
        h1, h2 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 25px;
            font-weight: 600; /* 标题稍微粗一点 */
        }
        .container {
            max-width: 1200px; /* 增加最大宽度以容纳更多内容 */
            margin: 30px auto;
            background-color: #ffffff;
            padding: 35px;
            border-radius: 12px; /* 更大的圆角 */
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.1); /* 更深更柔和的阴影 */
        }

        /* 区块样式 */
        .section {
            margin-bottom: 30px;
            padding: 25px;
            border: 1px solid #e9ecef; /* 极浅的边框 */
            border-radius: 10px;
            background-color: #ffffff; /* 内部区块也用白色背景 */
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.06); /* 内部区块的轻微阴影 */
        }
        .result-display {
            background-color: #e6f4ea; /* 浅绿色背景 */
            border-color: #a8e6b5; /* 绿色边框 */
            text-align: center;
            font-size: 1.6em; /* 稍微大一点 */
            font-weight: bold;
            color: #2e7d32; /* 深绿色文字 */
            padding: 22px; /* 稍微多一点的内边距 */
            margin-top: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08); /* 结果块的阴影 */
        }

        /* 输入框布局 */
        .input-fields-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 20px; /* 调整间距 */
            margin-bottom: 20px;
            justify-content: flex-start; /* 左对齐 */
        }
        .input-group-item {
            flex: 1 1 calc(33.33% - 20px); /* 每行3个 */
            display: flex;
            flex-direction: column;
            min-width: 200px; /* 最小宽度 */
        }
        .input-group-item label {
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
            font-size: 0.95em;
        }
        .input-group-item input[type="text"],
        .input-group-item input[type="number"],
        .input-group-item select {
            padding: 12px 15px;
            border: 1px solid #ced4da; /* 默认边框色 */
            border-radius: 6px;
            font-size: 1em;
            box-sizing: border-box;
            width: 100%;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        .input-group-item input[type="text"]:focus,
        .input-group-item input[type="number"]:focus,
        .input-group-item select:focus {
            border-color: #4CAF50;
            box-shadow: 0 0 0 4px rgba(76, 175, 80, 0.25); /* 更明显的聚焦阴影 */
            outline: none;
        }
        /* 禁用输入框样式 */
        /* 移除 productCodeInput 的 disabled 样式，因为它现在是可编辑的 */
        .input-group-item input[disabled]:not(#productCodeInput) {
            background-color: #e9ecef;
            cursor: not-allowed;
        }

        /* 按钮样式 */
        button {
            padding: 12px 25px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            margin-right: 15px;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.15); /* 按钮默认阴影 */
        }
        button:last-child {
            margin-right: 0;
        }
        button:hover {
            transform: translateY(-3px); /* 稍微大一点的位移 */
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.25); /* 更明显的悬停阴影 */
        }

        button.primary {
            background-color: #4CAF50; /* 绿色 */
            color: white;
        }
        button.primary:hover {
            background-color: #43a047;
        }
        button.danger {
            background-color: #f44336; /* 红色 */
            color: white;
        }
        button.danger:hover {
            background-color: #e53935;
        }
        button.success {
            background-color: #2196F3; /* 蓝色 */
            color: white;
        }
        button.success:hover {
            background-color: #1976D2;
        }
        button.info {
            background-color: #ff9800; /* 橙色 */
            color: white;
        }
        button.info:hover {
            background-color: #fb8c00;
        }

        /* 表格容器，用于横向滚动 */
        .table-responsive {
            overflow-x: auto; /* 启用横向滚动 */
            -webkit-overflow-scrolling: touch; /* iOS 上的平滑滚动 */
            border-radius: 8px; /* 继承表格的圆角 */
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1); /* 继承表格的阴影 */
            margin-top: 25px; /* 保持与表格的间距 */
        }

        /* 表格样式 */
        table {
            width: 100%; /* 确保表格宽度可以撑开 */
            min-width: 1450px; /* 增加最小宽度以适应新增列 */
            border-collapse: collapse;
            background-color: #fff;
        }
        th, td {
            padding: 14px 18px;
            text-align: left;
            border-bottom: 1px solid #e9ecef; /* 更细的边框 */
        }
        th {
            background-color: #f8f9fa; /* 浅灰色表头背景 */
            color: #2c3e50;
            font-weight: bold;
            text-transform: uppercase;
            font-size: 0.9em;
        }
        tr:nth-child(even) {
            background-color: #fcfdff; /* 斑马纹 */
        }
        tr:hover {
            background-color: #f5f7fa; /* 悬停高亮 */
        }
        td button {
            padding: 8px 12px;
            font-size: 0.8em;
            margin-right: 0;
            box-shadow: none; /* 表格内的按钮不需要阴影 */
            transform: none; /* 表格内的按钮不需要位移效果 */
        }
        td button:hover {
            background-color: #e0e0e0; /* 表格内删除按钮悬停效果 */
        }

        .action-buttons-container {
            display: flex;
            justify-content: flex-start; /* 调整为左对齐 */
            gap: 15px;
            margin-top: 20px;
        }

        /* 提示信息样式 */
        .tip-message {
            background-color: #fff3cd; /* Light yellow */
            border: 1px solid #ffeeba;
            color: #856404; /* Dark yellow text */
            padding: 10px 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            text-align: center;
            font-size: 0.95em;
        }
        .tip-message p {
            margin: 0; /* Remove default paragraph margin */
        }

        /* 交易所参数查询标题样式 */
        .exchange-section-title {
            color: #2c3e50;
            text-align: center;
            margin-top: 25px; /* 增加与上方提示的间距 */
            margin-bottom: 15px; /* 增加与下方按钮的间距 */
            font-size: 1.2em; /* 稍微缩小标题字体 */
        }

        /* 交易所链接按钮容器样式 - 调整为紧凑型 */
        .exchange-links {
            display: flex;
            flex-wrap: wrap; /* 允许按钮换行 */
            justify-content: center; /* 居中对齐 */
            gap: 8px; /* 按钮之间的间距更小 */
            margin-bottom: 20px; /* 增加与下方分隔线的间距 */
        }
        /* 交易所按钮样式 - 调整为更小 */
        .exchange-button {
            background-color: #007bff; /* 蓝色 */
            color: white;
            padding: 8px 12px; /* 按钮内边距更小 */
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em; /* 字体更小 */
            text-decoration: none; /* 移除链接下划线 */
            transition: background-color 0.3s ease;
            flex-grow: 0; /* 不允许按钮增长 */
            max-width: 120px; /* 限制单个按钮的最大宽度，使其更紧凑 */
            text-align: center;
        }
        .exchange-button:hover {
            background-color: #0056b3; /* 鼠标悬停时颜色变深 */
        }

        /* 分隔线样式 */
        hr {
            margin: 25px 0; /* 增加上下间距 */
            border-top: 1px solid #eee;
            border-bottom: none; /* 确保只有一条线 */
        }

        .error-message {
            color: #d32f2f;
            background-color: #ffebee;
            border: 1px solid #ef9a9a;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
            display: none; /* Hidden by default */
        }

        /* 汇总结果样式 */
        .summary-totals {
            margin-top: 25px;
            padding: 15px;
            background-color: #e8f5e9;
            border: 1px solid #c8e6c9;
            border-radius: 4px;
            text-align: center;
            font-size: 1.2em;
            font-weight: bold;
            color: #2e7d32;
        }
        .summary-totals p {
            margin: 5px 0;
        }

        /* 响应式调整 */
        @media (max-width: 1024px) {
            .input-group-item {
                flex: 1 1 calc(50% - 20px); /* 中等屏幕每行2个 */
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
                margin: 20px auto;
            }
            .input-fields-grid {
                flex-direction: column;
                gap: 15px;
            }
            .input-group-item {
                flex: 1 1 100%;
                min-width: unset;
            }
            button {
                width: 100%;
                margin-bottom: 10px;
                margin-right: 0;
            }
            .action-buttons-container {
                flex-direction: column;
            }
            th, td {
                padding: 10px 12px; /* 稍微减少内边距 */
                font-size: 0.85em; /* 稍微减小字体 */
            }
            th {
                white-space: nowrap; /* 防止表头文字换行 */
            }
            table {
                box-shadow: none;
                border-radius: 0;
            }
            /* 移除针对 .exchange-links 和 .exchange-button 的移动端特定样式，
               让它们继承全局的 flex-wrap 和 max-width 属性 */
            /*
            .exchange-links {
                flex-direction: column;
                align-items: center;
            }
            .exchange-button {
                width: 100%;
                max-width: 200px;
            }
            */
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>期货综合计算器</h1>

        <!-- 提示信息 -->
        <div class="tip-message">
            <p><strong>提示:</strong> 保证金率仅供参考，实际请以交易所数据为准。</p>
        </div>

        <!-- 交易所参数查询标题 -->
        <h2 class="exchange-section-title">交易所参数查询</h2>
        <!-- 交易所参数查询链接的容器 -->
        <div class="exchange-links" id="exchangeLinksContainer">
            <!-- 链接将由JavaScript动态加载并插入此处 -->
        </div>

        <hr>

        <div class="section">
            <h2>添加交易</h2>
            <div class="input-fields-grid">
                <div class="input-group-item">
                    <label for="exchangeSelect">交易所 (可选):</label>
                    <select id="exchangeSelect">
                        <option value="">请选择交易所</option>
                    </select>
                </div>
                <div class="input-group-item">
                    <label for="productSelect">品种 (可选):</label>
                    <select id="productSelect">
                        <option value="">请选择品种</option>
                    </select>
                </div>
                <div class="input-group-item">
                    <label for="productCodeInput">品种代码:</label>
                    <input type="text" id="productCodeInput" placeholder="例如: CU">
                </div>
                <div class="input-group-item">
                    <label for="unitsPerLotInput">每手单位:</label>
                    <input type="number" id="unitsPerLotInput" value="" min="1" step="1" placeholder="例如: 10">
                </div>
                <div class="input-group-item">
                    <label for="marginRatioInput">保证金比例 (%):</label>
                    <input type="number" id="marginRatioInput" value="" min="0.01" step="0.01" placeholder="例如: 10 (表示10%)">
                </div>
                <div class="input-group-item">
                    <label for="openLotsInput">开仓手数:</label>
                    <input type="number" id="openLotsInput" value="" min="1" step="1" placeholder="例如: 5">
                </div>
                <div class="input-group-item">
                    <label for="openPriceInput">开仓价格:</label>
                    <input type="number" id="openPriceInput" value="" min="0.01" step="0.01" placeholder="例如: 5000">
                </div>
                <div class="input-group-item">
                    <label for="currentPriceInput">当前价格:</label>
                    <input type="number" id="currentPriceInput" value="" min="0.01" step="0.01" placeholder="例如: 5050">
                </div>
                <div class="input-group-item">
                    <label for="tradeDirection">买卖方向:</label>
                    <select id="tradeDirection">
                        <option value="buy">买入</option>
                        <option value="sell">卖出</option>
                    </select>
                </div>
            </div>
            <button id="addTradeBtn" class="primary">添加交易</button>
            <div class="error-message" id="errorMessage"></div>
        </div>

        <hr>

        <div class="section">
            <h2>已添加交易列表</h2>
            <div class="table-responsive">
                <table id="tradeTable">
                    <thead>
                        <tr>
                            <th>品种代码</th>
                            <th>每手单位</th>
                            <th>保证金比例 (%)</th>
                            <th>开仓价格</th>
                            <th>开仓手数</th>
                            <th>开仓金额 (元)</th>
                            <th>当前价格</th>
                            <th>买卖方向</th>
                            <th>初始保证金占用 (元)</th>
                            <th>盈亏额 (元)</th>
                            <th>总权益 (元)</th>
                            <th>保证金占用 (元)</th>
                            <th>可用资金 (元)</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="tradeListBody">
                        <!-- 交易行将在这里动态添加 -->
                    </tbody>
                </table>
            </div>
            <!-- 导入导出按钮和隐藏的文件输入框 -->
            <div class="action-buttons-container" style="justify-content: flex-start; margin-top: 15px;">
                <input type="file" id="csvFileInput" accept=".csv" style="display: none;">
                <button id="importCsvBtn" class="info">导入交易 (CSV)</button>
                <button id="exportCsvBtn" class="info">导出交易 (CSV)</button>
            </div>
        </div>

        <hr>

        <div class="section">
            <h2>汇总计算结果</h2>
            <button id="calculateSummaryBtn" class="success">开始计算</button>
            <div class="table-responsive" style="margin-top: 20px;">
                <table id="summaryTable">
                    <thead>
                        <tr>
                            <th>品种代码</th>
                            <th>买卖方向</th>
                            <th>汇总手数</th>
                            <th>均价</th>
                            <th>初始保证金占用 (元)</th>
                            <th>汇总盈亏额 (元)</th>
                            <th>总权益 (元)</th>
                            <th>保证金占用 (元)</th>
                            <th>可用资金 (元)</th>
                        </tr>
                    </thead>
                    <tbody id="summaryTableBody">
                        <!-- 汇总结果将在这里动态添加 -->
                    </tbody>
                </table>
            </div>
            <div id="overallTotals" class="summary-totals" style="display: none;">
                <p>所有品种总初始保证金占用: <span id="totalInitialMarginDisplay">0.00</span> 元</p>
                <p>所有品种总盈亏额: <span id="totalPnlDisplay">0.00</span> 元</p>
                <p>所有品种总权益: <span id="totalEquityDisplay">0.00</span> 元</p>
                <p>所有品种总保证金占用: <span id="totalMarginDisplay">0.00</span> 元</p>
                <p>所有品种总可用资金: <span id="totalAvailableFundsDisplay">0.00</span> 元</p>
            </div>
        </div>
    </div>

    <script>
        // 全局数据存储
        let allFuturesData = []; // 从 futures_data.csv 加载的品种数据
        let trades = [];         // 用户添加的交易列表

        // 获取DOM元素
        const exchangeLinksContainer = document.getElementById('exchangeLinksContainer');
        const exchangeSelect = document.getElementById('exchangeSelect');
        const productSelect = document.getElementById('productSelect');
        const productCodeInput = document.getElementById('productCodeInput');
        const unitsPerLotInput = document.getElementById('unitsPerLotInput');
        const marginRatioInput = document.getElementById('marginRatioInput');
        const openLotsInput = document.getElementById('openLotsInput');
        const openPriceInput = document.getElementById('openPriceInput');
        const currentPriceInput = document.getElementById('currentPriceInput');
        const tradeDirection = document.getElementById('tradeDirection');
        const addTradeBtn = document.getElementById('addTradeBtn');
        const errorMessageDiv = document.getElementById('errorMessage');
        const tradeListBody = document.getElementById('tradeListBody');
        const calculateSummaryBtn = document.getElementById('calculateSummaryBtn');
        const summaryTableBody = document.getElementById('summaryTableBody');
        const overallTotalsDiv = document.getElementById('overallTotals');
        const totalPnlDisplay = document.getElementById('totalPnlDisplay');
        const totalEquityDisplay = document.getElementById('totalEquityDisplay');
        const totalMarginDisplay = document.getElementById('totalMarginDisplay');
        const totalInitialMarginDisplay = document.getElementById('totalInitialMarginDisplay');
        const totalAvailableFundsDisplay = document.getElementById('totalAvailableFundsDisplay'); // 新增：获取总可用资金显示元素

        // 新增导入导出相关DOM元素
        const exportCsvBtn = document.getElementById('exportCsvBtn');
        const importCsvBtn = document.getElementById('importCsvBtn');
        const csvFileInput = document.getElementById('csvFileInput');


        // --- 数据加载函数 ---

        // 异步加载期货数据CSV文件
        async function loadFuturesData() {
            try {
                const response = await fetch('futures_data.csv');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const csvText = await response.text();
                parseFuturesCSV(csvText);
            } catch (error) {
                console.error('加载期货数据文件失败:', error);
                showError('无法加载期货数据文件 (futures_data.csv)。请确保文件存在且格式正确。');
            }
        }

        // 解析期货数据CSV文本
        function parseFuturesCSV(csvText) {
            const lines = csvText.split('\n').filter(line => line.trim() !== '');
            if (lines.length === 0) {
                showError('期货数据CSV文件为空或格式不正确。');
                return;
            }

            const dataLines = lines.slice(1); // 跳过标题行
            
            allFuturesData = dataLines.map(line => {
                const parts = line.split(',');
                if (parts.length >= 5) {
                    return {
                        exchange: parts[0].trim(),
                        code: parts[1].trim(),
                        name: parts[2].trim(),
                        unit: parseFloat(parts[3]),
                        ratio: parseFloat(parts[4])
                    };
                }
                return null;
            }).filter(item => item !== null && !isNaN(item.unit) && !isNaN(item.ratio));

            if (allFuturesData.length === 0) {
                showError('期货数据CSV文件中没有有效的期货数据。请检查格式。');
                return;
            }

            populateExchangeSelect();
            populateProductSelect(allFuturesData); // 初始填充所有品种
        }

        // 异步加载交易所链接CSV文件
        async function loadExchangeLinks() {
            try {
                const response = await fetch('exchange_links.csv');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const csvText = await response.text();
                const links = parseExchangeLinksCSV(csvText);
                renderExchangeLinks(links);
            } catch (error) {
                console.error('加载交易所链接文件失败:', error);
                // 链接加载失败不影响主功能，可以不显示错误信息给用户，只在控制台输出
            }
        }

        // 解析交易所链接CSV文本
        function parseExchangeLinksCSV(csvText) {
            const lines = csvText.split('\n').filter(line => line.trim() !== '');
            if (lines.length === 0) return [];

            const dataLines = lines.slice(1); // 跳过标题行
            return dataLines.map(line => {
                const parts = line.split(',');
                if (parts.length >= 2) {
                    return {
                        name: parts[0].trim(),
                        url: parts[1].trim()
                    };
                }
                return null;
            }).filter(item => item !== null);
        }

        // 渲染交易所链接按钮
        function renderExchangeLinks(links) {
            exchangeLinksContainer.innerHTML = ''; // 清空现有内容
            links.forEach(link => {
                const anchor = document.createElement('a');
                anchor.href = link.url;
                anchor.textContent = link.name;
                anchor.target = '_blank'; // 在新标签页打开
                anchor.classList.add('exchange-button'); // 应用CSS样式
                exchangeLinksContainer.appendChild(anchor);
            });
        }

        // --- 下拉框填充和事件处理 ---

        // 填充交易所下拉框
        function populateExchangeSelect() {
            const exchanges = new Set();
            allFuturesData.forEach(item => exchanges.add(item.exchange));

            exchangeSelect.innerHTML = '<option value="">请选择交易所</option>';
            exchanges.forEach(exchange => {
                const option = document.createElement('option');
                option.value = exchange;
                option.textContent = exchange;
                exchangeSelect.appendChild(option);
            });
        }

        // 填充品种选择下拉框
        function populateProductSelect(dataToUse) {
            productSelect.innerHTML = '<option value="">请选择品种</option>';
            dataToUse.forEach(item => {
                const option = document.createElement('option');
                option.value = item.code;
                option.textContent = `${item.code} - ${item.name}`;
                productSelect.appendChild(option);
            });
        }

        // 处理交易所选择事件
        exchangeSelect.addEventListener('change', () => {
            const selectedExchange = exchangeSelect.value;
            let filteredProducts = [];

            if (selectedExchange === "") {
                filteredProducts = allFuturesData; // 如果未选择交易所，显示所有品种
            } else {
                filteredProducts = allFuturesData.filter(item => item.exchange === selectedExchange);
            }
            populateProductSelect(filteredProducts);

            // 清空品种选择和下方输入框
            productSelect.value = ""; 
            productCodeInput.value = ''; // 清空品种代码，等待用户选择或手动输入
            unitsPerLotInput.value = '';
            marginRatioInput.value = '';
            hideError();
        });

        // 处理品种选择事件
        productSelect.addEventListener('change', () => {
            const selectedCode = productSelect.value;
            const selectedProduct = allFuturesData.find(item => item.code === selectedCode);

            if (selectedProduct) {
                productCodeInput.value = selectedProduct.code;
                unitsPerLotInput.value = selectedProduct.unit;
                marginRatioInput.value = selectedProduct.ratio;
                hideError();
            } else {
                // 如果选择“请选择品种”，则清空相关字段
                productCodeInput.value = '';
                unitsPerLotInput.value = '';
                marginRatioInput.value = '';
            }
        });

        // --- 交易管理函数 ---

        // 添加交易
        addTradeBtn.addEventListener('click', () => {
            hideError();

            // 交易所字段现在是可选的，如果用户没选，就用空字符串
            const exchange = exchangeSelect.value;
            const productCode = productCodeInput.value.trim().toUpperCase(); // 直接从输入框获取
            const unitsPerLot = parseFloat(unitsPerLotInput.value);
            const marginRatio = parseFloat(marginRatioInput.value);
            const openLots = parseFloat(openLotsInput.value);
            const openPrice = parseFloat(openPriceInput.value);
            const currentPrice = parseFloat(currentPriceInput.value);
            const direction = tradeDirection.value;

            // 验证输入
            // 交易所不再是必填项
            if (!productCode) { showError('品种代码不能为空。'); return; }
            if (isNaN(unitsPerLot) || unitsPerLot <= 0) { showError('每手单位必须是有效的正数。'); return; }
            if (isNaN(marginRatio) || marginRatio <= 0 || marginRatio > 100) { showError('保证金比例必须是0到100之间的有效数字。'); return; }
            if (isNaN(openLots) || openLots <= 0) { showError('开仓手数必须是有效的正整数。'); return; }
            if (isNaN(openPrice) || openPrice <= 0) { showError('开仓价格必须是有效的正数。'); return; }
            if (isNaN(currentPrice) || currentPrice <= 0) { showError('当前价格必须是有效的正数。'); return; }

            // 计算开仓金额 (基于开仓价格，用于显示)
            const openAmount = openLots * openPrice * unitsPerLot;
            // 计算初始保证金 (基于开仓价格)
            const initialMarginRequired = openLots * openPrice * unitsPerLot * (marginRatio / 100);
            // 计算当前保证金 (基于当前价格)
            const currentMarginRequired = openLots * currentPrice * unitsPerLot * (marginRatio / 100);
            // 计算盈亏额
            let pnl;
            if (direction === 'buy') {
                pnl = (currentPrice - openPrice) * openLots * unitsPerLot;
            } else { // sell
                pnl = (openPrice - currentPrice) * openLots * unitsPerLot;
            }
            // 计算总权益 (初始保证金 + 浮动盈亏)
            const totalEquity = initialMarginRequired + pnl; 
            // 计算可用资金 (总权益 - 当前保证金占用)
            const availableFunds = totalEquity - currentMarginRequired;

            const newTrade = {
                exchange: exchange, // 记录用户选择的交易所，即使是空字符串
                productCode: productCode,
                unitsPerLot: unitsPerLot,
                marginRatio: marginRatio,
                openLots: openLots,
                openPrice: openPrice,
                currentPrice: currentPrice, // 保存当前价格
                direction: direction,
                openAmount: openAmount,
                initialMarginRequired: initialMarginRequired, // 保存初始保证金占用
                marginRequired: currentMarginRequired, // 保存当前保证金占用
                pnl: pnl,
                totalEquity: totalEquity, // 保存总权益
                availableFunds: availableFunds // 保存可用资金
            };

            trades.push(newTrade);
            renderTradeList();
            
            // 保持所有输入框数据不变
            hideError();

            // 清空汇总结果
            summaryTableBody.innerHTML = '';
            overallTotalsDiv.style.display = 'none';
        });

        // 渲染交易列表
        function renderTradeList() {
            tradeListBody.innerHTML = ''; // 清空现有内容

            trades.forEach((trade, index) => {
                const row = tradeListBody.insertRow();
                row.insertCell().textContent = trade.productCode;
                row.insertCell().textContent = trade.unitsPerLot.toFixed(2);
                row.insertCell().textContent = trade.marginRatio.toFixed(2);
                row.insertCell().textContent = trade.openPrice.toFixed(2);
                row.insertCell().textContent = trade.openLots.toFixed(0);
                row.insertCell().textContent = trade.openAmount.toFixed(2);
                row.insertCell().textContent = trade.currentPrice.toFixed(2);
                row.insertCell().textContent = trade.direction === 'buy' ? '买入' : '卖出';
                row.insertCell().textContent = trade.initialMarginRequired.toFixed(2);
                row.insertCell().textContent = trade.pnl.toFixed(2);
                row.insertCell().textContent = trade.totalEquity.toFixed(2);
                row.insertCell().textContent = trade.marginRequired.toFixed(2); // 位置调整
                row.insertCell().textContent = trade.availableFunds.toFixed(2);

                const actionCell = row.insertCell();
                const deleteButton = document.createElement('button');
                deleteButton.textContent = '删除';
                deleteButton.className = 'danger';
                deleteButton.onclick = () => deleteTrade(index);
                actionCell.appendChild(deleteButton);
            });
        }

        // 删除交易
        function deleteTrade(index) {
            if (confirm('确定要删除这笔交易吗？')) {
                trades.splice(index, 1);
                renderTradeList();
                // 清空汇总结果
                summaryTableBody.innerHTML = '';
                overallTotalsDiv.style.display = 'none';
            }
        }

        // --- 汇总计算函数 ---

        calculateSummaryBtn.addEventListener('click', () => {
            if (trades.length === 0) {
                showError('请先添加交易数据！');
                summaryTableBody.innerHTML = '';
                overallTotalsDiv.style.display = 'none';
                return;
            }
            hideError();
            renderSummaryTable();
        });

        function renderSummaryTable() {
            summaryTableBody.innerHTML = ''; // 清空现有汇总内容

            // 使用Map来按品种代码和方向分组
            const groupedTrades = new Map(); // Key: "productCode_direction"

            trades.forEach(trade => {
                const key = `${trade.productCode}_${trade.direction}`;
                if (!groupedTrades.has(key)) {
                    groupedTrades.set(key, {
                        productCode: trade.productCode,
                        direction: trade.direction,
                        totalLots: 0,
                        totalWeightedOpenPrice: 0, // 用于计算均价
                        totalInitialMarginRequired: 0, // 汇总初始保证金占用
                        totalMarginRequired: 0, // 汇总当前保证金占用
                        totalPnl: 0,
                        totalTotalEquity: 0, // 汇总总权益
                        totalAvailableFunds: 0, // 汇总可用资金
                        unitsPerLot: trade.unitsPerLot // 假设同一品种的每手单位一致
                    });
                }

                const group = groupedTrades.get(key);
                group.totalLots += trade.openLots;
                group.totalWeightedOpenPrice += trade.openPrice * trade.openLots;
                group.totalInitialMarginRequired += trade.initialMarginRequired;
                group.totalMarginRequired += trade.marginRequired;
                group.totalPnl += trade.pnl;
                group.totalTotalEquity += group.totalInitialMarginRequired + group.totalPnl; // 重新计算汇总总权益
                group.totalAvailableFunds += group.totalTotalEquity - group.totalMarginRequired; // 重新计算汇总可用资金
            });

            let overallTotalPnl = 0;
            let overallTotalEquity = 0; // 所有品种总总权益
            let overallTotalMargin = 0; // 所有品种总当前保证金占用
            let overallTotalInitialMargin = 0; // 所有品种总初始保证金占用
            let overallTotalAvailableFunds = 0; // 所有品种总可用资金

            // 渲染汇总表格
            groupedTrades.forEach(group => {
                const row = summaryTableBody.insertRow();
                const averagePrice = group.totalWeightedOpenPrice / group.totalLots;

                row.insertCell().textContent = group.productCode;
                row.insertCell().textContent = group.direction === 'buy' ? '买入' : '卖出';
                row.insertCell().textContent = group.totalLots.toFixed(0);
                row.insertCell().textContent = averagePrice.toFixed(4);
                row.insertCell().textContent = group.totalInitialMarginRequired.toFixed(2);
                row.insertCell().textContent = group.totalPnl.toFixed(2);
                row.insertCell().textContent = group.totalTotalEquity.toFixed(2); // 显示汇总总权益
                row.insertCell().textContent = group.totalMarginRequired.toFixed(2); // 位置调整
                row.insertCell().textContent = group.totalAvailableFunds.toFixed(2); // 显示汇总可用资金

                overallTotalPnl += group.totalPnl;
                overallTotalEquity += group.totalTotalEquity; // 累加到总总权益
                overallTotalMargin += group.totalMarginRequired;
                overallTotalInitialMargin += group.totalInitialMarginRequired;
                overallTotalAvailableFunds += group.totalAvailableFunds; // 累加到总可用资金
            });

            // 显示总计
            totalInitialMarginDisplay.textContent = overallTotalInitialMargin.toFixed(2); // 调整顺序
            totalPnlDisplay.textContent = overallTotalPnl.toFixed(2); // 调整顺序
            totalEquityDisplay.textContent = overallTotalEquity.toFixed(2); // 调整顺序
            totalMarginDisplay.textContent = overallTotalMargin.toFixed(2); // 调整顺序
            totalAvailableFundsDisplay.textContent = overallTotalAvailableFunds.toFixed(2); // 调整顺序
            overallTotalsDiv.style.display = 'block';
        }

        // --- 导入导出功能 ---

        // 函数：导出CSV
        function exportCsv() {
            if (trades.length === 0) {
                alert('没有数据可以导出！');
                return;
            }

            let csvContent = "data:text/csv;charset=utf-8,\uFEFF"; // 添加BOM头解决中文乱码

            // CSV 表头 - 仅导出可直接输入的字段
            csvContent += "交易所,品种代码,每手单位,保证金比例 (%),开仓手数,开仓价格,当前价格,买卖方向\n";

            // CSV 数据行
            trades.forEach(trade => {
                csvContent += `${trade.exchange || ''},` + // 交易所可能是空字符串
                              `${trade.productCode},` +
                              `${trade.unitsPerLot.toFixed(2)},` +
                              `${trade.marginRatio.toFixed(2)},` +
                              `${trade.openLots.toFixed(0)},` +
                              `${trade.openPrice.toFixed(2)},` +
                              `${trade.currentPrice.toFixed(2)},` +
                              `${trade.direction === 'buy' ? '买入' : '卖出'}\n`; // 转换为中文
            });

            // 创建下载链接
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "futures_trades_data.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // 函数：导入CSV
        function importCsv(event) {
            const file = event.target.files[0];
            if (!file) {
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const csvText = e.target.result;
                parseCsvAndLoadTable(csvText);
            };
            reader.onerror = function() {
                showError('读取文件失败！');
            };
            reader.readAsText(file, 'UTF-8'); // 使用UTF-8编码读取，处理BOM
        }

        // 函数：解析CSV文本并加载到表格
        function parseCsvAndLoadTable(csvText) {
            const lines = csvText.split('\n').filter(line => line.trim() !== ''); // 过滤空行
            if (lines.length < 2) { // 至少需要标题行和一行数据
                showError('CSV文件内容不正确或为空！');
                return;
            }

            // 清空现有数据
            trades = [];
            summaryTableBody.innerHTML = '';
            overallTotalsDiv.style.display = 'none';
            hideError();

            const header = lines[0].split(',').map(h => h.trim());
            const expectedHeader = ["交易所", "品种代码", "每手单位", "保证金比例 (%)", "开仓手数", "开仓价格", "当前价格", "买卖方向"];

            // 简单检查表头是否匹配，或者至少包含关键字段
            const headerMatch = expectedHeader.every(h => header.includes(h));
            if (!headerMatch) {
                showError('CSV文件表头不匹配，请确保包含以下列：' + expectedHeader.join(', '));
                return;
            }

            const importedTrades = [];
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue; // 跳过空行

                const columns = line.split(',');
                if (columns.length !== expectedHeader.length) {
                    console.warn(`跳过格式不正确的行 (列数不匹配): ${line}`);
                    continue;
                }

                const tradeData = {};
                expectedHeader.forEach((key, index) => {
                    tradeData[key] = columns[index].trim();
                });

                const exchange = tradeData["交易所"];
                const productCode = tradeData["品种代码"].toUpperCase();
                const unitsPerLot = parseFloat(tradeData["每手单位"]);
                const marginRatio = parseFloat(tradeData["保证金比例 (%)"]);
                const openLots = parseFloat(tradeData["开仓手数"]);
                const openPrice = parseFloat(tradeData["开仓价格"]);
                const currentPrice = parseFloat(tradeData["当前价格"]);
                const direction = tradeData["买卖方向"] === '买入' ? 'buy' : (tradeData["买卖方向"] === '卖出' ? 'sell' : '');

                // 验证导入数据的有效性
                if (!productCode || isNaN(unitsPerLot) || unitsPerLot <= 0 ||
                    isNaN(marginRatio) || marginRatio <= 0 || marginRatio > 100 ||
                    isNaN(openLots) || openLots <= 0 ||
                    isNaN(openPrice) || openPrice <= 0 ||
                    isNaN(currentPrice) || currentPrice <= 0 ||
                    !['buy', 'sell'].includes(direction)) {
                    console.warn('跳过无效的交易数据行:', line);
                    continue;
                }

                // 重新计算派生字段
                const openAmount = openLots * openPrice * unitsPerLot;
                // 初始保证金占用 (基于开仓价格)
                const initialMarginRequired = openLots * openPrice * unitsPerLot * (marginRatio / 100);
                // 当前保证金占用 (基于当前价格)
                const currentMarginRequired = openLots * currentPrice * unitsPerLot * (marginRatio / 100);
                let pnl;
                if (direction === 'buy') {
                    pnl = (currentPrice - openPrice) * openLots * unitsPerLot;
                } else { // sell
                    pnl = (openPrice - currentPrice) * openLots * unitsPerLot;
                }
                const totalEquity = initialMarginRequired + pnl; // 总权益 = 初始保证金占用 + 浮动盈亏
                const availableFunds = totalEquity - currentMarginRequired; // 可用资金 = 总权益 - 保证金占用

                importedTrades.push({
                    exchange: exchange,
                    productCode: productCode,
                    unitsPerLot: unitsPerLot,
                    marginRatio: marginRatio,
                    openLots: openLots,
                    openPrice: openPrice,
                    currentPrice: currentPrice,
                    direction: direction,
                    openAmount: openAmount,
                    initialMarginRequired: initialMarginRequired,
                    marginRequired: currentMarginRequired,
                    pnl: pnl,
                    totalEquity: totalEquity, // 重新计算并保存总权益
                    availableFunds: availableFunds // 重新计算并保存可用资金
                });
            }

            if (importedTrades.length === 0) {
                showError('CSV文件中没有有效的交易数据可导入！');
            } else {
                trades = importedTrades; // 替换现有交易数据
                renderTradeList();
                alert(`成功导入 ${trades.length} 条交易数据！`);
            }
        }

        // --- 错误信息显示 ---

        function showError(message) {
            errorMessageDiv.textContent = message;
            errorMessageDiv.style.display = 'block';
        }

        function hideError() {
            errorMessageDiv.textContent = '';
            errorMessageDiv.style.display = 'none';
        }

        // --- 页面初始化 ---
        document.addEventListener('DOMContentLoaded', () => {
            loadFuturesData();
            loadExchangeLinks();
            renderTradeList(); // 初始渲染空列表

            // 绑定导入导出事件监听器
            exportCsvBtn.addEventListener('click', exportCsv);
            importCsvBtn.addEventListener('click', () => {
                csvFileInput.click(); // 触发隐藏的文件输入框点击
            });
            csvFileInput.addEventListener('change', importCsv);
        });
    </script>
</body>
</html>